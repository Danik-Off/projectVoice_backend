name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  MYSQL_ROOT_PASSWORD: 'rootpassword'
  MYSQL_DATABASE: 'test_projectvoice'
  MYSQL_USER: 'test_projectvoice'
  MYSQL_PASSWORD: 'TZ8TSEWPet5kJnzN'

jobs:
  # Job для проверки качества кода
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run ESLint
      run: npm run lint
      
    - name: Check Prettier formatting
      run: npm run prettier
      
    - name: Check for security vulnerabilities
      run: npm audit --audit-level=high

  # Job для тестирования
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ env.MYSQL_DATABASE }}
          MYSQL_USER: ${{ env.MYSQL_USER }}
          MYSQL_PASSWORD: ${{ env.MYSQL_PASSWORD }}
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -p${{ env.MYSQL_ROOT_PASSWORD }}"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Wait for MySQL
      run: |
        while ! mysqladmin ping -h localhost -u root -p${{ env.MYSQL_ROOT_PASSWORD }} --silent; do
          echo "Waiting for MySQL to be ready..."
          sleep 2
        done
        
    - name: Setup test environment
      run: |
        cp .env.example .env.test
        echo "DB_USERNAME=${{ env.MYSQL_USER }}" >> .env.test
        echo "DB_PASSWORD=${{ env.MYSQL_PASSWORD }}" >> .env.test
        echo "DB_DATABASE=${{ env.MYSQL_DATABASE }}" >> .env.test
        echo "DB_HOST=localhost" >> .env.test
        echo "DB_DIALECT=mysql" >> .env.test
        echo "NODE_ENV=test" >> .env.test
        echo "JWT_SECRET=test_secret_key" >> .env.test
        
    - name: Run database migrations
      run: |
        NODE_ENV=test npm run db:migrate
      env:
        NODE_ENV: test
        
    - name: Run tests
      run: npm test
      env:
        NODE_ENV: test

  # Job для сборки и проверки
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [lint-and-format, test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Generate API documentation
      run: npm run docs-gen
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: |
          node_modules/
          package.json
          package-lock.json
          index.js
          config/
          models/
          routes/
          middleware/
          utils/
        retention-days: 7

  # Job для деплоя в staging (только для develop ветки)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install production dependencies
      run: npm ci --only=production
      
    - name: Deploy to staging server
      run: |
        echo "Deploying to staging server..."
        # Здесь будет команда для деплоя на staging сервер
        # Например, через SSH или API вашего хостинг-провайдера
        echo "Staging deployment completed"
      env:
        STAGING_HOST: ${{ secrets.STAGING_HOST }}
        STAGING_USER: ${{ secrets.STAGING_USER }}
        STAGING_KEY: ${{ secrets.STAGING_KEY }}

  # Job для деплоя в production (только для main ветки)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install production dependencies
      run: npm ci --only=production
      
    - name: Run database migrations
      run: |
        echo "Running production database migrations..."
        # Здесь будет команда для запуска миграций в production
        echo "Database migrations completed"
      env:
        DB_HOST: ${{ secrets.PROD_DB_HOST }}
        DB_USERNAME: ${{ secrets.PROD_DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
        DB_DATABASE: ${{ secrets.PROD_DB_DATABASE }}
        
    - name: Deploy to production server
      run: |
        echo "Deploying to production server..."
        # Здесь будет команда для деплоя на production сервер
        echo "Production deployment completed"
      env:
        PROD_HOST: ${{ secrets.PROD_HOST }}
        PROD_USER: ${{ secrets.PROD_USER }}
        PROD_KEY: ${{ secrets.PROD_KEY }}
        
    - name: Health check
      run: |
        echo "Performing health check..."
        # Здесь будет проверка работоспособности приложения
        sleep 30
        echo "Health check completed"

  # Job для создания релиза
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from package.json
      id: version
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Release v${{ steps.version.outputs.version }}
        body: |
          ## Changes in v${{ steps.version.outputs.version }}
          
          - Automated deployment to production
          - Database migrations applied
          - Health checks passed
          
          ## Deployment Details
          - Environment: Production
          - Branch: ${{ github.ref }}
          - Commit: ${{ github.sha }}
        draft: false
        prerelease: false

